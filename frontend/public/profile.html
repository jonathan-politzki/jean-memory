<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEAN - Your AI Memory Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="dashboard-logo">
                <div class="logo-icon">J</div>
                <h1>JEAN</h1>
            </div>
            <div class="user-profile">
                <div class="avatar" id="userInitial">U</div>
                <span id="userEmail">user@example.com</span>
            </div>
        </div>

        <!-- API Key Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Your MCP Configuration</h2>
                <button class="copy-btn" id="copyConfigBtn">Copy Config</button>
            </div>
            
            <p>Use this configuration with compatible AI assistants like Claude Desktop and Cursor.</p>
            
            <div class="api-key-display">
                <pre id="mcpConfigDisplay">Loading your configuration...</pre>
            </div>
            
            <div id="configCopyMessage"></div>
        </div>

        <!-- Context Sources -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Connect Your Context Sources</h2>
            </div>
            
            <p>Add personal context from these sources to improve your AI assistant's memory:</p>
            
            <div class="source-grid">
                <!-- GitHub -->
                <div class="source-card" id="github-source">
                    <div class="source-icon">üìÇ</div>
                    <div class="source-name">GitHub</div>
                    <div class="source-status">Not connected</div>
                </div>
                
                <!-- Twitter/X -->
                <div class="source-card" id="twitter-source">
                    <div class="source-icon">üê¶</div>
                    <div class="source-name">Twitter/X</div>
                    <div class="source-status">Not connected</div>
                </div>
                
                <!-- Google Docs -->
                <div class="source-card" id="gdocs-source">
                    <div class="source-icon">üìù</div>
                    <div class="source-name">Google Docs</div>
                    <div class="source-status">Not connected</div>
                </div>
                
                <!-- Notion -->
                <div class="source-card" id="notion-source">
                    <div class="source-icon">üìî</div>
                    <div class="source-name">Notion</div>
                    <div class="source-status">Not connected</div>
                </div>
                
                <!-- Add Note -->
                <div class="source-card" id="note-source">
                    <div class="source-icon">‚úèÔ∏è</div>
                    <div class="source-name">Create Note</div>
                    <div class="source-status">Available</div>
                </div>
            </div>
        </div>
        
        <!-- Status Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">System Status</h2>
            </div>
            
            <div id="statusInfo">
                <p>‚úÖ Backend connection: <span id="backendStatus">checking...</span></p>
                <p>‚úÖ MCP endpoint: <span id="mcpStatus">checking...</span></p>
                <p>‚úÖ User authentication: <span id="authStatus">checking...</span></p>
            </div>
        </div>
    </div>

    <script>
        // Parse URL parameters
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            
            for (const [key, value] of urlParams) {
                params[key] = value;
            }
            
            console.log("URL parameters extracted:", { 
                userId: params.jean_user_id, 
                apiKeyFound: !!params.jean_api_key,
                apiKeyLength: params.jean_api_key ? params.jean_api_key.length : 0,
                apiKeyPrefix: params.jean_api_key ? params.jean_api_key.substring(0, 10) + '...' : 'none'
            });
            
            return params;
        }
        
        // Initialize the dashboard
        async function initDashboard() {
            const params = getUrlParams();
            const userId = params.jean_user_id || params.user_id; // Try both parameter names
            const apiKey = params.jean_api_key || params.api_key || 'TEST_API_KEY'; // Try both parameter names
            
            console.log("Dashboard initialized with:", { 
                userId, 
                apiKeyPrefix: apiKey ? apiKey.substring(0, 10) + '...' : 'none',
                apiKeyLength: apiKey ? apiKey.length : 0
            });
            
            if (!userId) {
                console.error("No user ID found in URL parameters, redirecting to login");
                // Redirect to the login page if no user ID is found
                window.location.href = '/';
                return;
            }
            
            // Update user profile
            document.getElementById('userInitial').textContent = 'U';
            document.getElementById('userEmail').textContent = `User ${userId}`;
            
            // Fetch and display MCP configuration
            try {
                const response = await fetch(`/api/mcp-config?api_key=${apiKey}`);
                const mcpConfig = await response.json();
                
                // Display the MCP configuration
                const configJson = JSON.stringify(mcpConfig, null, 2);
                document.getElementById('mcpConfigDisplay').textContent = configJson;
                
                // Set up copy button
                const copyBtn = document.getElementById('copyConfigBtn');
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(configJson).then(() => {
                        const message = document.getElementById('configCopyMessage');
                        message.textContent = '‚úÖ Configuration copied to clipboard!';
                        message.style.color = 'var(--secondary-color)';
                        
                        setTimeout(() => {
                            message.textContent = '';
                        }, 3000);
                    });
                });
            } catch (error) {
                console.error('Error fetching MCP config:', error);
                document.getElementById('mcpConfigDisplay').textContent = 'Error loading configuration';
            }
            
            // Check system status
            checkSystemStatus();
            
            // Set up context source card clicks
            setupSourceCards(userId, apiKey);
        }
        
        // Check system status
        async function checkSystemStatus() {
            try {
                // Check backend connection
                const healthResponse = await fetch('/health');
                const healthData = await healthResponse.json();
                document.getElementById('backendStatus').textContent = healthData.status === 'ok' ? 'Connected' : 'Disconnected';
                
                // Check MCP endpoint (via backend proxy)
                const backendUrl = 'http://localhost:8080';
                const mcpResponse = await fetch(`${backendUrl}/health`, { mode: 'cors' });
                document.getElementById('mcpStatus').textContent = mcpResponse.ok ? 'Available' : 'Unavailable';
                
                // Auth status is assumed to be OK if we're on this page
                document.getElementById('authStatus').textContent = 'Authenticated';
            } catch (error) {
                console.error('Error checking system status:', error);
                document.getElementById('backendStatus').textContent = 'Error';
                document.getElementById('mcpStatus').textContent = 'Error';
            }
        }
        
        // Set up context source cards
        function setupSourceCards(userId, apiKey) {
            const sourceCards = document.querySelectorAll('.source-card');
            
            sourceCards.forEach(card => {
                card.addEventListener('click', () => {
                    const sourceName = card.querySelector('.source-name').textContent;
                    const isConnected = card.querySelector('.source-status').classList.contains('status-connected');
                    
                    if (isConnected) {
                        console.log(`${sourceName} is already connected`);
                        return;
                    }
                    
                    // Show "coming soon" alert for unimplemented sources
                    if (sourceName !== 'Create Note') {
                        alert(`${sourceName} integration coming soon!`);
                        return;
                    }
                    
                    // For the note source, we'll implement it directly
                    if (sourceName === 'Create Note') {
                        const note = prompt('Enter your note:');
                        if (note) {
                            console.log("Creating note with API key:", {
                                apiKeyPrefix: apiKey ? apiKey.substring(0, 10) + '...' : 'none',
                                apiKeyLength: apiKey ? apiKey.length : 0
                            });
                            
                            // Send the note to the backend MCP endpoint
                            fetch('http://localhost:8080/mcp', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiKey}`,
                                    'x-api-key': apiKey
                                },
                                body: JSON.stringify({
                                    method: "store",
                                    params: {
                                        context_type: "notes",
                                        content: {
                                            title: "Quick Note",
                                            body: note,
                                            created_at: new Date().toISOString()
                                        },
                                        source_identifier: "quick_note_" + Date.now()
                                    }
                                })
                            })
                            .then(response => {
                                console.log("Response status:", response.status);
                                return response.json();
                            })
                            .then(data => {
                                console.log("MCP response data:", data);
                                if (data.result && data.result.type === "success") {
                                    alert('Note created and stored in your personal memory!');
                                } else {
                                    alert('Error storing note: ' + JSON.stringify(data.error || "Unknown error"));
                                }
                            })
                            .catch(error => {
                                console.error('Error storing note:', error);
                                alert('Failed to store note. See console for details.');
                            });
                        }
                    }
                });
            });
        }
        
        // Initialize when the page loads
        window.onload = initDashboard;
    </script>
</body>
</html> 